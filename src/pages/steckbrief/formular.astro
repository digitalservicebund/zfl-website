---
import Layout from "@/layouts/Layout.astro";
import Input from "@/components/input/Input.astro";
import Textarea from "@/components/input/Textarea.astro";
import { Icon } from "astro-icon/components";
import { buildUrl } from "@/utils/routesHelper";
import Card from "@/components/Card.astro";

export const frontmatter = {
  title: "Steckbrief",
  sitemap: false,
};

const steps = [
  {
    id: "kontaktdaten",
    label: "Kontaktdaten",
    progress: 25,
  },
  {
    id: "kontext",
    label: "Kontext",
    progress: 50,
  },
  {
    id: "zielstellung",
    label: "Zielstellung/Probleme",
    progress: 75,
  },
  {
    id: "zusammenfassung",
    label: "Zusammenfassung",
    progress: 100,
  },
];

const nextSteps = [
  {
    number: "1",
    title: "Steckbrief erstellen",
    completed: true,
    description:
      "Sie können den Steckbrief entweder selbst verfassen oder uns die relevanten Informationen zur Verfügung stellen – wir erstellen den Steckbrief und übernehmen dann die Ausformulierung für Sie. Wenn Sie den Steckbrief selbst verfassen möchten, nutzen Sie dazu unser Online-Formular; am Ende erhalten Sie den Steckbrief als Word-Dokument zum Download.",
  },
  {
    number: "2",
    title: "Interne Vervollständigung",
    description:
      "Das Word-Dokument ermöglicht Ihnen eine unkomplizierte interne Abstimmung in Ihrem Referat. Ergänzen Sie fehlende Informationen und stimmen Sie sich ebenfalls mit den beteiligten Ressorts ab, um den Steckbrief zu vervollständigen.",
  },
  {
    number: "3",
    title: "Versand an zuständige Institutionen",
    description:
      "Sobald Ihr Steckbrief vollständig ist, senden Sie ihn zur Information an den Normenkontrollrat und Destatis.",
  },
];
---

<Layout title={frontmatter.title}>
  <div class="form-wrapper">
    <div
      class="mx-auto flex max-w-[1296px] gap-48 py-80"
      x-data="{ hintsOpen: true, arbeitstitel: '', email: '', ressort: '', referat: '', rechtsbereich: '', kontext: '', zielstellung: '', probleme: '' }"
    >
      <!-- Hidden radio inputs for step navigation -->
      {
        steps.map((step) => (
          <input
            type="radio"
            name="step"
            id={`step-${step.id}`}
            class="step-radio"
            checked={step.id === "kontaktdaten"}
          />
        ))
      }

      <aside class="sidebar-column sticky top-0 w-[248px]">
        {
          steps.map((step) => (
            <label
              for={`step-${step.id}`}
              class="sidebar-item border-lavender-700 relative flex w-248 cursor-pointer items-center border-b py-16 pr-16 pl-32"
            >
              <div class="sidebar-indicator bg-cosmic-blue-base absolute top-0 bottom-0 left-0 h-full w-[3px]" />
              {step.label}
            </label>
          ))
        }
      </aside>

      <main class="max-w-a11y flex-1">
        <div class="bg-lavender-400 relative h-[5px] w-full">
          <div
            class="progress-bar bg-cosmic-blue-base absolute top-0 left-0 h-full"
          >
          </div>
        </div>

        <!-- Step 1: Kontaktdaten -->
        <div class="step-content py-40" data-step="kontaktdaten">
          <div class="space-y-24">
            <p class="text-xl">Ihre Kontaktinformationen</p>
            <Input label="E-Mail Adresse" id="email" x-model="email" />
            <div class="flex gap-24">
              <Input label="Ressort" id="ressort" x-model="ressort" />
              <Input label="Referat" id="referat" x-model="referat" />
            </div>
            <Input
              label="Ihr Rechtsbereich"
              id="rechtsbereich"
              x-model="rechtsbereich"
            />
          </div>
          <div class="mt-80 flex gap-48">
            <label for="step-kontext" class="btn btn-primary cursor-pointer"
              >Übernehmen und weiter</label
            >
            <a
              href={buildUrl("/steckbrief/prozess")}
              class="btn btn-secondary link-unstyled">Zurück</a
            >
          </div>
        </div>

        <!-- Step 2: Kontext -->
        <div class="step-content py-40" data-step="kontext">
          <div class="space-y-24">
            <Input
              label="Arbeitstitel"
              id="arbeitstitel"
              x-model="arbeitstitel"
            />
            <Textarea
              id="kontext"
              label="Kontext Ihres Vorhabens"
              description="Einordnung Ihres Handlungsbedarfs"
              maxlength={1000}
              x-model="kontext"
            />
          </div>
          <div class="mt-80 flex gap-48">
            <label
              for="step-zielstellung"
              class="btn btn-primary cursor-pointer"
              >Übernehmen und weiter</label
            >
            <label
              for="step-kontaktdaten"
              class="btn btn-secondary cursor-pointer">Zurück</label
            >
          </div>
        </div>

        <!-- Step 3: Zielstellung/Probleme -->
        <div class="step-content py-40" data-step="zielstellung">
          <div class="space-y-24">
            <Textarea
              id="zielstellung"
              label="Warum braucht es diese neue Regelung?"
              description="Was soll durch das Gesetz verbessert werden?"
              maxlength={1000}
              x-model="zielstellung"
            />
            <Textarea
              id="probleme"
              label="Welche Umsetzungshürden gibt es?"
              description="Was sind derzeitige Probleme in der Umsetzung?"
              maxlength={1000}
              x-model="probleme"
            />
          </div>
          <div class="mt-80 flex gap-48">
            <label
              for="step-zusammenfassung"
              class="btn btn-primary cursor-pointer"
              >Übernehmen und weiter</label
            >
            <label for="step-kontext" class="btn btn-secondary cursor-pointer"
              >Zurück</label
            >
          </div>
        </div>

        <!-- Step 4: Zusammenfassung -->
        <div class="step-content py-40" data-step="zusammenfassung">
          <div class="spacing-y-40">
            <Card wrapperClass="p-40!">
              <h2>Zusammenfassung</h2>
              <table class="mt-24 w-full border-collapse">
                <tbody>
                  <tr>
                    <td class="py-8 pr-24 align-top font-bold">Arbeitstitel</td>
                    <td class="py-8" x-text="arbeitstitel"></td>
                  </tr>
                  <tr>
                    <td class="py-8 pr-24 align-top font-bold"
                      >E-Mail Adresse</td
                    >
                    <td class="py-8" x-text="email"></td>
                  </tr>
                  <tr>
                    <td class="py-8 pr-24 align-top font-bold">Ressort</td>
                    <td class="py-8" x-text="ressort"></td>
                  </tr>
                  <tr>
                    <td class="py-8 pr-24 align-top font-bold">Referat</td>
                    <td class="py-8" x-text="referat"></td>
                  </tr>
                  <tr>
                    <td class="py-8 pr-24 align-top font-bold">Rechtsbereich</td
                    >
                    <td class="py-8" x-text="rechtsbereich"></td>
                  </tr>
                  <tr>
                    <td class="py-8 pr-24 align-top font-bold"
                      >Kontext Ihres Vorhabens</td
                    >
                    <td class="py-8 whitespace-pre-wrap" x-text="kontext"></td>
                  </tr>
                  <tr>
                    <td class="py-8 pr-24 align-top font-bold"
                      >Warum braucht es diese neue Regelung?</td
                    >
                    <td class="py-8 whitespace-pre-wrap" x-text="zielstellung"
                    ></td>
                  </tr>
                  <tr>
                    <td class="py-8 pr-24 align-top font-bold"
                      >Was sind Umsetzungshürden?</td
                    >
                    <td class="py-8 whitespace-pre-wrap" x-text="probleme"></td>
                  </tr>
                </tbody>
              </table>
              <div class="mt-40">
                <button
                  class="btn btn-primary"
                  @click="$dispatch('generate-word', { arbeitstitel, email, ressort, referat, rechtsbereich, kontext, zielstellung, probleme })"
                  >Steckbrief herunterladen</button
                >
              </div>
            </Card>
            <Card wrapperClass="mt-40 p-40!">
              <h3>Was passiert als nächstes?</h3>

              <div class="space-y-36">
                {
                  nextSteps.map((step) => (
                    <div
                      class={`group flex items-start gap-32 ${step.completed && "opacity-50"}`}
                    >
                      <div class="bg-lavender-400 border-lavender-400 flex h-40 w-40 shrink-0 items-center justify-center rounded-full border-2 text-lg font-bold">
                        {step.completed ? (
                          <Icon name="ic:twotone-check" />
                        ) : (
                          step.number
                        )}
                      </div>

                      <div class="grow">
                        <p class="mb-8 text-2xl font-bold">{step.title}</p>
                        <p class="text-base leading-relaxed opacity-80">
                          {step.description}
                        </p>
                      </div>
                    </div>
                  ))
                }
              </div>
            </Card>
          </div>
          <div class="mt-80 flex gap-48">
            <label
              for="step-zielstellung"
              class="btn btn-secondary cursor-pointer">Zurück</label
            >
          </div>
        </div>
      </main>

      <aside
        class="hints-column sticky top-0 w-[248px] transition-all duration-300"
      >
        <div
          class="border-cosmic-blue-400 absolute inset-0 w-248 border-l pt-40 pb-16 transition-transform duration-300"
          :class="hintsOpen ? 'translate-x-0 bg-lavender-200' : 'translate-x-full bg-transaparent'"
        >
          <div
            class="border-cosmic-blue-400 text-cosmic-blue-base absolute top-34 left-0 z-10 -translate-x-1/2 cursor-pointer rounded-full border bg-white p-8"
            @click="hintsOpen = !hintsOpen"
          >
            <Icon
              name="ic:twotone-arrow-forward-ios"
              class="transition-transform duration-300"
              :class="hintsOpen ? '' : 'rotate-180'"
            />
          </div>
          <div
            x-show="hintsOpen"
            x-transition:enter="transition-opacity duration-200"
            x-transition:enter-start="opacity-0"
            x-transition:enter-end="opacity-100"
            x-transition:leave="transition-opacity duration-100"
            x-transition:leave-start="opacity-100"
            x-transition:leave-end="opacity-0"
            class="h-full overflow-y-auto px-32"
          >
            <!-- Hints for Step 2: Kontext -->
            <div class="hint-content space-y-40" data-step="kontext">
              <div>
                <p class="mb-16 font-bold">Was bedeutet Kontext in dem Fall?</p>
                <p>
                  Erläutern Sie den Kontext Ihres Vorhabens anhand der
                  maßgeblichen Beschlüsse, Vereinbarungen oder politischen
                  Impulse.
                </p>
              </div>
              <div>
                <p class="mb-16 font-bold">
                  Gibt es bereits Inhalte zu dem Vorhaben?
                </p>
                <p>
                  Sollten Sie bereits Vorarbeiten für den Kontext haben, dann
                  ergänzen Sie sie hier.
                </p>
              </div>
            </div>

            <!-- Hints for Step 3: Zielstellung/Probleme -->
            <div class="hint-content space-y-40" data-step="zielstellung">
              <div>
                <p class="mb-16 font-bold">
                  Erläutern Sie warum es die neue Regelung braucht
                </p>
                <p>
                  Erläutern Sie den konkreten Handlungsbedarf. Beschreiben Sie,
                  welches Problem gelöst werden soll, warum bestehende
                  Regelungen nicht ausreichen und welchen Mehrwert eine neue
                  Regelung schafft.
                </p>
              </div>
              <div>
                <p class="mb-16 font-bold">
                  Erläutern Sie die möglichen Umsetzungshürden
                </p>
                <p>
                  Geben Sie an, welche fachlichen, organisatorischen,
                  technischen oder rechtlichen Hindernisse bei der Umsetzung
                  auftreten könnten. Beschreiben Sie kurz, wo mögliche Risiken
                  oder Schwierigkeiten liegen.
                </p>
              </div>
            </div>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <style>
    /* Hide radio inputs */
    .step-radio {
      display: none;
    }

    /* Hide all step content by default */
    .step-content {
      display: none;
    }

    /* Hide all hint content by default */
    .hint-content {
      display: none;
    }

    /* Hide sidebar indicators by default */
    .sidebar-indicator {
      display: none;
    }

    /* Show step content when corresponding radio is checked */
    #step-kontaktdaten:checked ~ main .step-content[data-step="kontaktdaten"],
    #step-kontext:checked ~ main .step-content[data-step="kontext"],
    #step-zielstellung:checked ~ main .step-content[data-step="zielstellung"],
    #step-anhang:checked ~ main .step-content[data-step="anhang"],
    #step-zusammenfassung:checked
      ~ main
      .step-content[data-step="zusammenfassung"] {
      display: block;
    }

    /* Show hint content when corresponding radio is checked */
    #step-kontaktdaten:checked
      ~ .hints-column
      .hint-content[data-step="kontaktdaten"],
    #step-kontext:checked ~ .hints-column .hint-content[data-step="kontext"],
    #step-zielstellung:checked
      ~ .hints-column
      .hint-content[data-step="zielstellung"],
    #step-anhang:checked ~ .hints-column .hint-content[data-step="anhang"],
    #step-zusammenfassung:checked
      ~ .hints-column
      .hint-content[data-step="zusammenfassung"] {
      display: block;
    }

    /* Style active sidebar item */
    #step-kontaktdaten:checked ~ .sidebar-column label[for="step-kontaktdaten"],
    #step-kontext:checked ~ .sidebar-column label[for="step-kontext"],
    #step-zielstellung:checked ~ .sidebar-column label[for="step-zielstellung"],
    #step-anhang:checked ~ .sidebar-column label[for="step-anhang"],
    #step-zusammenfassung:checked
      ~ .sidebar-column
      label[for="step-zusammenfassung"] {
      background-color: var(--color-lavender-base);
    }

    /* Show indicator for active sidebar item */
    #step-kontaktdaten:checked
      ~ .sidebar-column
      label[for="step-kontaktdaten"]
      .sidebar-indicator,
    #step-kontext:checked
      ~ .sidebar-column
      label[for="step-kontext"]
      .sidebar-indicator,
    #step-zielstellung:checked
      ~ .sidebar-column
      label[for="step-zielstellung"]
      .sidebar-indicator,
    #step-anhang:checked
      ~ .sidebar-column
      label[for="step-anhang"]
      .sidebar-indicator,
    #step-zusammenfassung:checked
      ~ .sidebar-column
      label[for="step-zusammenfassung"]
      .sidebar-indicator {
      display: block;
    }

    /* Update progress bar width based on active step */
    #step-kontaktdaten:checked ~ main .progress-bar {
      width: 20%;
    }
    #step-kontext:checked ~ main .progress-bar {
      width: 40%;
    }
    #step-zielstellung:checked ~ main .progress-bar {
      width: 60%;
    }
    #step-anhang:checked ~ main .progress-bar {
      width: 80%;
    }
    #step-zusammenfassung:checked ~ main .progress-bar {
      width: 100%;
    }

    /* Smooth transition for progress bar */
    .progress-bar {
      transition: width 0.3s ease-in-out;
    }

    /* Lavender background when Zusammenfassung step is active */
    .form-wrapper:has(#step-zusammenfassung:checked) {
      background-color: var(--color-lavender-400);
    }

    /* Hide hints sidebar in kontaktdaten & Zusammenfassung step is active */
    #step-kontaktdaten:checked ~ .hints-column,
    #step-zusammenfassung:checked ~ .hints-column {
      display: none;
    }

    /* Expand main when hints sidebar is hidden (248px sidebar + 48px gap) */
    #step-zusammenfassung:checked ~ main {
      max-width: calc(630px + 48px + 248px);
    }
  </style>

  <script>
    import { Document, Packer, Paragraph, TextRun } from "docx";

    interface FormData {
      arbeitstitel: string;
      email: string;
      ressort: string;
      referat: string;
      rechtsbereich: string;
      kontext: string;
      zielstellung: string;
      probleme: string;
    }

    async function generateWordDoc(data: FormData) {
      const fields = [
        { label: "Arbeitstitel", value: data.arbeitstitel },
        { label: "E-Mail Adresse", value: data.email },
        { label: "Ressort", value: data.ressort },
        { label: "Referat", value: data.referat },
        { label: "Rechtsbereich", value: data.rechtsbereich },
        { label: "Kontext", value: data.kontext },
        { label: "Zielstellung", value: data.zielstellung },
        { label: "Probleme", value: data.probleme },
      ];

      const fieldParagraphs = fields.flatMap(({ label, value }) => [
        new Paragraph({
          children: [new TextRun({ text: `${label}:`, bold: true })],
        }),
        new Paragraph({
          children: [new TextRun(value || "")],
        }),
        new Paragraph({ children: [] }),
      ]);

      const doc = new Document({
        sections: [
          {
            children: [
              new Paragraph({
                children: [
                  new TextRun({ text: "Steckbrief", bold: true, size: 32 }),
                ],
                spacing: { after: 400 },
              }),
              ...fieldParagraphs,
            ],
          },
        ],
      });

      const blob = await Packer.toBlob(doc);
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `steckbrief-${data.arbeitstitel || "export"}.docx`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    document.addEventListener("generate-word", (e) => {
      generateWordDoc((e as CustomEvent<FormData>).detail);
    });
  </script>
</Layout>
