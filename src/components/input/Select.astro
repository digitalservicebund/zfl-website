---
import type { HTMLAttributes } from "astro/types";

interface Props extends HTMLAttributes<"select"> {
  label: string;
  options: string[];
}
const { label, options, id, name = "select", ...rest } = Astro.props;
const placeholder = "Bitte w√§hlen";
---

<div
  class="w-full"
  x-data="{ open: false, selected: '', focusedIndex: -1 }"
  x-init="$watch('selected', val => $dispatch('select-change', val))"
  @click.outside="open = false"
  @keyup.escape="open = false; $refs.trigger.focus()"
  @keydown.down.prevent="open = true; focusedIndex = (focusedIndex + 1) % $refs.list.children.length; $refs.list.children[focusedIndex].focus()"
  @keydown.up.prevent="open = true; focusedIndex = (focusedIndex - 1 + $refs.list.children.length) % $refs.list.children.length; $refs.list.children[focusedIndex].focus()"
  @keydown.tab="open = false"
>
  <label for={id}>{label}</label>

  <select {id} {name} class="sr-only" aria-hidden="true" tabindex="-1" x-model="selected" {...rest}>
    <option value="">{placeholder}</option>
    {options.map((option) => <option value={option}>{option}</option>)}
  </select>

  <div class="custom-select">
    <button
      type="button"
      class="select-trigger border-cosmic-blue-base w-full border-2 px-24 py-12 text-left focus:shadow-[inset_0_0_0_2px_var(--color-cosmic-blue-base)]"
      :class="open && 'shadow-[inset_0_0_0_2px_var(--color-cosmic-blue-base)]'"
      @click="open = !open"
      @keydown.enter.prevent="open = !open"
      @keydown.space.prevent="open = !open"
      aria-haspopup="listbox"
      :aria-expanded="open"
      x-ref="trigger"
    >
      <span x-text={`selected || '${placeholder}'`}></span>
    </button>

    <ul class="select-options" role="listbox" x-show="open" x-ref="list">
      {options.map((option) => (
        <li
          role="option"
          class="option-item"
          :class={`selected === '${option}' && 'option-item--selected'`}
          @click={`selected = '${option}'; open = false`}
          @keydown.enter={`selected = '${option}'; open = false`}
          @keydown.space.prevent={`selected = '${option}'; open = false`}
          tabindex="0"
        >{option}</li>
      ))}
    </ul>
  </div>
</div>

<style>
  .custom-select {
    position: relative;
    width: 100%;
  }

  .select-trigger {
    cursor: pointer;
    background-color: white;
    outline: none;
    user-select: none;
    transition: box-shadow 0.15s ease;
  }

  .select-trigger::after {
    content: "";
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    width: 0;
    height: 0;
    border-left: 6px solid transparent;
    border-right: 6px solid transparent;
    border-top: 6px solid currentColor;
    transition: transform 0.2s ease;
  }

  .select-options {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    margin-top: 4px;
    list-style: none;
    padding: 0;
    box-shadow:
      0 8px 16px -4px rgba(0, 0, 0, 0.15),
      0 4px 8px -2px rgba(0, 0, 0, 0.1);
    z-index: 10;
    max-height: 300px;
    overflow-y: auto;
  }

  .option-item {
    display: block;
    padding: 12px 24px;
    cursor: pointer;
    transition: background-color 0.15s ease;
    user-select: none;
  }

  .option-item:hover {
    background-color: var(--color-lavender-200);
  }

  .option-item:focus {
    outline: 2px solid var(--color-cosmic-blue-400);
    outline-offset: -2px;
  }

  .option-item--selected {
    background-color: var(--color-lavender-400);
    font-weight: 500;
    border-left: 4px solid var(--color-cosmic-blue-base);
    padding-left: 20px;
  }
</style>
