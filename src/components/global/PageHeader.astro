---
import Kopfzeile from "@/components/global/Kopfzeile.astro";
import Link from "@/components/Link.astro";
import { ZFL_EMAIL, ZFL_PHONE } from "@/config/constants";
import navigation from "@/config/routes";
import { isStaging } from "@/config/stage";
import bundLogo from "@/images/logo/bund-logo.png";
import { buildUrl, removeTrailingSlash } from "@/utils/routesHelper";
import { Icon } from "astro-icon/components";
import { Image } from "astro:assets";
import { twMerge } from "tailwind-merge";

const { pathname } = Astro.url;
const currentPath = removeTrailingSlash(pathname);

const headerNavigation = navigation.filter(
  (item) => item.showInHeader !== false && (!item.isStagingOnly || isStaging),
);

const basicLinkClasses = "flex items-center hover:bg-lavender-base";
const activeClasses = "border-cosmic-blue-base bg-lavender-base";
---

<header
  class="relative"
  x-data="{ mobileMenuOpen: false }"
  @resize.window="mobileMenuOpen = false"
>
  <Kopfzeile className="relative z-30" />
  <div
    class="border-lavender-base relative z-30 flex h-[72px] justify-between border-b-2 bg-white pl-16 md:px-16"
  >
    <!-- Logo and title -->
    <a href={buildUrl("/")} class="link-unstyled flex items-center space-x-8">
      <Image src={bundLogo} alt="Logo des Bundes" class="w-56" />
      <p
        class="ds-label-01-bold ml-16 flex flex-col text-xl text-black max-lg:hidden"
      >
        Zentrum für Legistik
      </p>
    </a>

    <!-- Desktop Navigation -->
    <nav class="flex items-center max-md:hidden" data-testid="desktop-nav">
      {
        headerNavigation.map((item) => (
          <a
            href={buildUrl(item.path)}
            class={twMerge(
              basicLinkClasses,
              "ds-label-01-reg relative h-full border-b-4 border-transparent px-16 whitespace-nowrap",
              currentPath === item.path && activeClasses,
            )}
          >
            {item.title}
          </a>
        ))
      }
      <div class="ds-label-01-reg px-16 text-nowrap text-gray-800">
        Kontakt:{" "}
        <Link href={ZFL_EMAIL.url}>{ZFL_EMAIL.display}</Link>
      </div>
    </nav>

    <!-- Mobile View Controls -->
    <div class="flex items-center space-x-16 md:hidden">
      <a
        href={ZFL_PHONE.url}
        class="border-b-4 border-transparent"
        aria-label={ZFL_PHONE.display}
      >
        <Icon name="ic:twotone-phone-enabled" class="size-24 -scale-x-100" />
      </a>
      <button
        class="hover:bg-lavender-base aria-expanded:border-cosmic-blue-base aria-expanded:bg-lavender-base h-full border-b-4 border-transparent px-16"
        @click="mobileMenuOpen = !mobileMenuOpen"
        aria-label="Menü öffnen / schließen"
        :aria-expanded="mobileMenuOpen"
        aria-controls="mobile-menu"
      >
        <Icon x-show="!mobileMenuOpen" name="ic:twotone-menu" class="size-24" />
        <Icon
          x-show="mobileMenuOpen"
          name="ic:twotone-menu-open"
          class="size-24"
          style="display: none;"
        />
      </button>
    </div>
  </div>
  <!-- Mobile Navigation -->
  <nav
    id="mobile-menu"
    class="absolute right-0 left-0 z-20 bg-white drop-shadow-[4px_4px_12px_rgba(0,0,0,0.06)]"
    x-show="mobileMenuOpen"
    style="display: none;"
    :aria-hidden="!mobileMenuOpen"
  >
    {
      headerNavigation.map((item) => (
        <a
          href={item.path}
          class={twMerge(
            basicLinkClasses,
            "ds-label-01-reg border-l-4 border-transparent p-16",
            currentPath === item.path && activeClasses,
          )}
        >
          {item.title}
        </a>
      ))
    }
    <div class="ds-label-01-reg ml-4 p-16 text-gray-800">
      Kontakt:{" "}
      <Link href={ZFL_EMAIL.url}>{ZFL_EMAIL.display}</Link>
    </div>
  </nav>
  <noscript>
    <div class="bg-yellow-200">
      <div class="breakout-grid py-4">
        <p>
          <strong>Menü funktioniert nicht?</strong> Erlauben Sie JavaScript in den
          Browsereinstellungen oder navigieren Sie über den <Link href="#footer"
            >Footer</Link
          >.
        </p>
      </div>
    </div>
  </noscript>
</header>
